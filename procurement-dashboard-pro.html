<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procurement AI Copilot - Professional Dashboard</title>
    <style>
        :root {
            /* PITCH BLACK - Default Theme */
            --primary-color: #ffffff;
            --primary-dark: #cccccc;
            --secondary-color: #888888;
            --accent-color: #ffffff;
            --success-color: #ffffff;
            --warning-color: #ffffff;
            --error-color: #ffffff;
            
            --bg-primary: #000000;
            --bg-secondary: #111111;
            --bg-tertiary: #222222;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-muted: #888888;
            --border-primary: #333333;
            --border-secondary: #444444;
            --accent-primary: #ffffff;
            --accent-hover: #cccccc;
            --shadow: rgba(255, 255, 255, 0.1);
            --shadow-lg: rgba(255, 255, 255, 0.2);
        }

        [data-theme="light"] {
            /* Light Mode - Optional */
            --primary-color: #000000;
            --primary-dark: #333333;
            --secondary-color: #666666;
            --accent-color: #000000;
            --success-color: #000000;
            --warning-color: #000000;
            --error-color: #000000;
            
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #eeeeee;
            --text-primary: #000000;
            --text-secondary: #333333;
            --text-muted: #666666;
            --border-primary: #cccccc;
            --border-secondary: #dddddd;
            --accent-primary: #000000;
            --accent-hover: #333333;
            --shadow: rgba(0, 0, 0, 0.1);
            --shadow-lg: rgba(0, 0, 0, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
            padding-right: 24px;
            transition: padding-right 0.3s ease;
        }

        .container.ai-open {
            padding-right: 424px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-primary);
            padding-bottom: 24px;
            margin-bottom: 32px;
        }

        .header-content h1 {
            font-size: 32px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .header-content p {
            color: var(--text-secondary);
            font-size: 16px;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Home Button */
        .home-button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            color: var(--text-primary);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .home-button:hover {
            background: var(--primary-color);
            color: var(--bg-primary);
            border-color: var(--primary-color);
        }

        .creator-badge {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Theme Toggle */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .theme-toggle:hover {
            background: var(--bg-tertiary);
        }

        .theme-icon {
            font-size: 16px;
        }

        /* AI Assistant Toggle */
        .ai-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--accent-primary);
            color: var(--bg-primary);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .ai-toggle:hover {
            background: var(--accent-hover);
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 32px;
            border-bottom: 1px solid var(--border-primary);
        }

        .nav-tab {
            padding: 12px 16px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .nav-tab.active {
            color: var(--text-primary);
            border-bottom-color: var(--accent-primary);
        }

        .nav-tab:hover {
            color: var(--text-primary);
        }

        /* Cards */
        .card {
            background: var(--bg-primary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px var(--shadow);
            transition: all 0.3s ease;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-description {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 4px;
        }

        /* Grid Layout */
        .grid {
            display: grid;
            gap: 24px;
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        /* Upload Section */
        .upload-area {
            border: 2px dashed var(--border-primary);
            border-radius: 8px;
            padding: 48px 24px;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
            background: var(--bg-secondary);
        }

        .upload-area:hover {
            border-color: var(--accent-primary);
            background: var(--bg-tertiary);
        }

        .upload-area.dragover {
            border-color: var(--accent-primary);
            background: var(--bg-tertiary);
        }

        .upload-icon {
            font-size: 48px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .upload-text {
            font-size: 16px;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .upload-subtext {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .btn:hover {
            background: var(--bg-secondary);
        }

        .btn-primary {
            background: var(--accent-primary);
            color: var(--bg-primary);
            border-color: var(--accent-primary);
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Alert Cards */
        .alert-card {
            border-left: 4px solid #ef4444;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .alert-card.medium {
            border-left-color: #f59e0b;
        }

        .alert-card.low {
            border-left-color: #10b981;
        }

        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .alert-title {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
        }

        .alert-priority {
            font-size: 12px;
            font-weight: 500;
            padding: 2px 8px;
            border-radius: 4px;
            background: #ef4444;
            color: white;
        }

        .alert-priority.medium {
            background: #f59e0b;
        }

        .alert-priority.low {
            background: #10b981;
        }

        .alert-content {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .alert-actions {
            display: flex;
            gap: 8px;
        }

        /* Edit/Delete Actions */
        .insight-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        /* AI Reasoning Display */
        .ai-reasoning {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            font-size: 14px;
        }

        .ai-reasoning-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .ai-reasoning-content {
            line-height: 1.6;
            color: var(--text-primary);
        }

        .insight-section {
            margin-bottom: 20px;
        }

        .insight-section h4 {
            color: var(--accent-primary);
            margin-bottom: 8px;
            font-size: 16px;
        }

        .finding-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-secondary);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
        }

        .finding-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .finding-impact {
            color: var(--success-color);
            font-weight: 600;
        }

        .finding-details {
            font-size: 13px;
        }

        .confidence {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .insight-section ul {
            margin: 8px 0;
            padding-left: 20px;
        }

        .insight-section li {
            margin-bottom: 4px;
        }

        .ai-response-text {
            line-height: 1.6;
            color: var(--text-primary);
        }

        .ai-response-text p {
            margin-bottom: 12px;
        }

        .ai-response-text strong {
            color: var(--accent-primary);
        }

        .ai-response-text em {
            color: var(--text-secondary);
            font-style: italic;
        }

        /* Data Management Panel */
        .data-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .data-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* OpenWebUI Status */
        .openwebui-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            font-size: 12px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
        }

        .status-dot.error {
            background: #ef4444;
        }

        /* Modal for editing */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        /* Stats */
        .stat-card {
            text-align: center;
            padding: 24px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* AI Assistant Sidebar */
        .ai-sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: var(--bg-primary);
            border-left: 1px solid var(--border-primary);
            box-shadow: -4px 0 12px var(--shadow);
            transition: right 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .ai-sidebar.open {
            right: 0;
        }

        .ai-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .ai-close {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .ai-close:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .ai-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .ai-messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .ai-message {
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.4;
        }

        .ai-message.user {
            background: var(--accent-primary);
            color: var(--bg-primary);
            margin-left: 20%;
            align-self: flex-end;
        }

        .ai-message.assistant {
            background: var(--bg-secondary);
            color: var(--text-primary);
            margin-right: 20%;
            align-self: flex-start;
        }

        .ai-input-area {
            padding: 24px;
            border-top: 1px solid var(--border-primary);
            display: flex;
            gap: 12px;
        }

        .ai-input {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            resize: none;
            outline: none;
        }

        .ai-input:focus {
            border-color: var(--accent-primary);
        }

        .ai-send {
            padding: 12px 16px;
            background: var(--accent-primary);
            color: var(--bg-primary);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .ai-send:hover {
            background: var(--accent-hover);
        }

        .ai-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Loading States */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-primary);
            border-top: 2px solid var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Hidden */
        .hidden {
            display: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            .container.ai-open {
                padding-right: 16px;
            }
            
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                overflow-x: auto;
                white-space: nowrap;
            }

            .ai-sidebar {
                width: 100vw;
                right: -100vw;
            }

            .header {
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }

            .header-controls {
                align-self: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="mainContainer">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <h1>Procurement AI Copilot</h1>
                <p>AI-powered procurement analysis with proactive contract management</p>
            </div>
            <div class="header-controls">
                <div class="creator-badge">
                    <span>by Ahmad Basheer</span>
                </div>
                <a href="/" class="home-button">
                    <span>üè†</span>
                    Home
                </a>
                <div class="openwebui-status" id="openwebuiStatus">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">OpenWebUI Connected</span>
                </div>
                <button class="theme-toggle" id="themeToggle">
                    <span class="theme-icon" id="themeIcon">üåô</span>
                    <span id="themeText">Dark</span>
                </button>
                <button class="ai-toggle" id="aiToggle">
                    <span>üí¨</span>
                    AI Assistant
                </button>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="upload">Upload & Analyze</button>
            <button class="nav-tab" data-tab="categories">Spend Categories</button>
            <button class="nav-tab" data-tab="trends">Trends</button>
            <button class="nav-tab" data-tab="alerts">Contract Alerts</button>
            <button class="nav-tab" data-tab="insights">Insights</button>
        </div>

        <!-- Upload Tab -->
        <div id="upload-tab" class="tab-content">
            <div class="grid grid-2">
                <!-- Upload Section -->
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title">Upload Procurement Data</h3>
                            <p class="card-description">Upload CSV or Excel files for analysis</p>
                        </div>
                    </div>
                    
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">üìÑ</div>
                        <div class="upload-text">Drop files here or click to browse</div>
                        <div class="upload-subtext">Supports CSV and Excel files</div>
                        <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;">
                    </div>
                    
                    <div style="margin-top: 16px; display: flex; gap: 12px;">
                        <button class="btn btn-primary" id="analyzeBtn" disabled>
                            <span class="loading hidden" id="analyzeLoading"></span>
                            Analyze Data
                        </button>
                        <button class="btn" id="sampleDataBtn">Use Sample Data</button>
                    </div>

                    <!-- Data Management Panel -->
                    <div class="data-panel hidden" id="dataPanel">
                        <h4 style="margin-bottom: 12px; font-size: 14px; font-weight: 600;">Data Management</h4>
                        <div class="data-actions">
                            <button class="btn btn-sm" id="exportDataBtn">üìä Export Results</button>
                            <button class="btn btn-sm" id="clearDataBtn">üóëÔ∏è Clear Data</button>
                            <button class="btn btn-sm" id="viewRawDataBtn">üëÅÔ∏è View Raw Data</button>
                            <button class="btn btn-sm" id="aiReasoningBtn">ü§ñ Show AI Reasoning</button>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title">Analysis Summary</h3>
                            <p class="card-description">Key metrics from your data</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-3">
                        <div class="stat-card">
                            <div class="stat-value" id="recordCount">0</div>
                            <div class="stat-label">Records</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalSavings">$0</div>
                            <div class="stat-label">Potential Savings</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="insightCount">0</div>
                            <div class="stat-label">Insights</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Spend Categories Tab -->
        <div id="categories-tab" class="tab-content hidden">
            <div class="grid grid-2">
                <!-- Category Breakdown -->
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title">Spend by Category</h3>
                            <p class="card-description">AI-powered spend categorization</p>
                        </div>
                        <button class="btn" id="categorizeBtn">
                            <span class="loading hidden" id="categorizeLoading"></span>
                            Categorize Spend
                        </button>
                    </div>
                    
                    <div id="categoryBreakdown">
                        <div style="text-align: center; padding: 48px; color: var(--text-secondary);">
                            <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
                            <div>No categorization yet</div>
                            <div style="font-size: 14px; margin-top: 8px;">Upload data and categorize to see spend breakdown</div>
                        </div>
                    </div>
                </div>

                <!-- Category Insights -->
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title">Category Insights</h3>
                            <p class="card-description">Optimization opportunities by category</p>
                        </div>
                    </div>
                    
                    <div id="categoryInsights">
                        <div style="text-align: center; padding: 48px; color: var(--text-secondary);">
                            <div style="font-size: 48px; margin-bottom: 16px;">üí°</div>
                            <div>No category insights</div>
                            <div style="font-size: 14px; margin-top: 8px;">Categorize your spend to see optimization opportunities</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trends Tab -->
        <div id="trends-tab" class="tab-content hidden">
            <div class="grid grid-2">
                <!-- Trend Summary -->
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title">Performance Trends</h3>
                            <p class="card-description">Track your procurement optimization progress</p>
                        </div>
                        <button class="btn" id="refreshTrendsBtn">
                            <span class="loading hidden" id="trendsLoading"></span>
                            Refresh Data
                        </button>
                    </div>
                    
                    <div id="trendSummary">
                        <div style="text-align: center; padding: 48px; color: var(--text-secondary);">
                            <div style="font-size: 48px; margin-bottom: 16px;">üìà</div>
                            <div>Loading trend data...</div>
                            <div style="font-size: 14px; margin-top: 8px;">Analyzing historical performance</div>
                        </div>
                    </div>
                </div>

                <!-- Key Metrics -->
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title">Key Metrics</h3>
                            <p class="card-description">Month-over-month performance indicators</p>
                        </div>
                    </div>
                    
                    <div id="keyMetrics">
                        <div class="grid grid-3">
                            <div class="stat-card">
                                <div class="stat-value" id="totalSavingsIdentified">$0</div>
                                <div class="stat-label">Total Savings Identified</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="avgMonthlyInsights">0</div>
                                <div class="stat-label">Avg Monthly Insights</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="complianceImprovement">0%</div>
                                <div class="stat-label">Compliance Improvement</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-2">
                <!-- Savings Trend Chart -->
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title">Potential Savings Over Time</h3>
                            <p class="card-description">Monthly savings opportunities identified</p>
                        </div>
                    </div>
                    
                    <div id="savingsChart" style="height: 300px; display: flex; align-items: center; justify-content: center; color: var(--text-secondary);">
                        <div>Chart will appear here after loading trend data</div>
                    </div>
                </div>

                <!-- Insights Trend Chart -->
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title">Insights Discovery Trend</h3>
                            <p class="card-description">Number of optimization opportunities found</p>
                        </div>
                    </div>
                    
                    <div id="insightsChart" style="height: 300px; display: flex; align-items: center; justify-content: center; color: var(--text-secondary);">
                        <div>Chart will appear here after loading trend data</div>
                    </div>
                </div>
            </div>

            <!-- Compliance and Efficiency Trends -->
            <div class="grid grid-2">
                <!-- Compliance Trend -->
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title">Compliance Improvement</h3>
                            <p class="card-description">Reduction in non-compliant spending</p>
                        </div>
                    </div>
                    
                    <div id="complianceChart" style="height: 250px; display: flex; align-items: center; justify-content: center; color: var(--text-secondary);">
                        <div>Chart will appear here after loading trend data</div>
                    </div>
                </div>

                <!-- Processing Efficiency -->
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title">Processing Efficiency</h3>
                            <p class="card-description">Analysis time and duplicate vendor reduction</p>
                        </div>
                    </div>
                    
                    <div id="efficiencyChart" style="height: 250px; display: flex; align-items: center; justify-content: center; color: var(--text-secondary);">
                        <div>Chart will appear here after loading trend data</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contract Alerts Tab -->
        <div id="alerts-tab" class="tab-content hidden">
            <div class="card">
                <div class="card-header">
                    <div>
                        <h3 class="card-title">Contract Renewal Alerts</h3>
                        <p class="card-description">Proactive notifications for upcoming contract renewals</p>
                    </div>
                    <button class="btn" id="detectContractsBtn">
                        <span class="loading hidden" id="contractLoading"></span>
                        Scan for Contracts
                    </button>
                </div>
                
                <div id="alertsContainer">
                    <div style="text-align: center; padding: 48px; color: var(--text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 16px;">üìÖ</div>
                        <div>No contract alerts yet</div>
                        <div style="font-size: 14px; margin-top: 8px;">Upload data and scan for contracts to get started</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Insights Tab -->
        <div id="insights-tab" class="tab-content hidden">
            <div class="card">
                <div class="card-header">
                    <div>
                        <h3 class="card-title">Procurement Insights</h3>
                        <p class="card-description">AI-powered analysis and recommendations</p>
                    </div>
                </div>
                
                <div id="insightsContainer">
                    <div style="text-align: center; padding: 48px; color: var(--text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 16px;">üí°</div>
                        <div>No insights available</div>
                        <div style="font-size: 14px; margin-top: 8px;">Upload and analyze data to see insights</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Assistant Sidebar -->
    <div class="ai-sidebar" id="aiSidebar">
        <div class="ai-header">
            <h3 class="ai-title">AI Procurement Assistant</h3>
            <button class="ai-close" id="aiClose">√ó</button>
        </div>
        <div class="ai-chat">
            <div class="ai-messages" id="aiMessages">
                <div class="ai-message assistant">
                    üëã Hi! I'm your AI procurement assistant. Ask me about:
                    <br><br>
                    ‚Ä¢ Vendor management strategies
                    <br>‚Ä¢ Cost optimization techniques  
                    <br>‚Ä¢ Contract negotiation tips
                    <br>‚Ä¢ Procurement best practices
                </div>
            </div>
            <div class="ai-input-area">
                <textarea class="ai-input" id="aiInput" placeholder="Ask about procurement..." rows="2"></textarea>
                <button class="ai-send" id="aiSend">
                    <span class="loading hidden" id="aiLoading"></span>
                    <span id="aiSendText">Send</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Insight Modal -->
    <div class="modal hidden" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Insight</h3>
                <button class="modal-close" id="modalClose">√ó</button>
            </div>
            <form id="editForm">
                <div class="form-group">
                    <label class="form-label">Title</label>
                    <input type="text" class="form-input" id="editTitle" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-input form-textarea" id="editDescription" required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Potential Savings ($)</label>
                    <input type="number" class="form-input" id="editSavings" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <select class="form-input" id="editPriority">
                        <option value="LOW">Low</option>
                        <option value="MEDIUM">Medium</option>
                        <option value="HIGH">High</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Next Step</label>
                    <textarea class="form-input form-textarea" id="editNextStep" required></textarea>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" class="btn" id="cancelEdit">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- AI Reasoning Modal -->
    <div class="modal hidden" id="reasoningModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üß† AI Analysis Insights</h3>
                <button class="modal-close" id="reasoningModalClose">√ó</button>
            </div>
            <div id="reasoningContent">
                <div style="text-align: center; padding: 20px;">
                    <div class="loading"></div>
                    <div style="margin-top: 12px;">Fetching AI reasoning...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentData = null;
        let currentAnalysis = null;
        let currentInsights = [];
        let editingInsightIndex = -1;

        // Theme management
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        const themeText = document.getElementById('themeText');
        
        // Load saved theme or default to DARK (PITCH BLACK)
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        updateThemeUI(savedTheme);

        // Check OpenWebUI status on load
        checkOpenWebUIStatus();

        themeToggle.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeUI(newTheme);
        });

        function updateThemeUI(theme) {
            if (theme === 'dark') {
                themeIcon.textContent = '‚òÄÔ∏è';
                themeText.textContent = 'Light';
            } else {
                themeIcon.textContent = 'üåô';
                themeText.textContent = 'Dark';
            }
        }

        // AI Assistant management
        const aiToggle = document.getElementById('aiToggle');
        const aiSidebar = document.getElementById('aiSidebar');
        const aiClose = document.getElementById('aiClose');
        const mainContainer = document.getElementById('mainContainer');

        aiToggle.addEventListener('click', () => {
            aiSidebar.classList.add('open');
            mainContainer.classList.add('ai-open');
        });

        aiClose.addEventListener('click', () => {
            aiSidebar.classList.remove('open');
            mainContainer.classList.remove('ai-open');
        });

        // Data management functionality
        document.getElementById('exportDataBtn').addEventListener('click', exportResults);
        document.getElementById('clearDataBtn').addEventListener('click', clearAllData);
        document.getElementById('viewRawDataBtn').addEventListener('click', viewRawData);
        document.getElementById('aiReasoningBtn').addEventListener('click', showAIReasoning);

        // Modal functionality
        document.getElementById('modalClose').addEventListener('click', closeEditModal);
        document.getElementById('cancelEdit').addEventListener('click', closeEditModal);
        document.getElementById('reasoningModalClose').addEventListener('click', closeReasoningModal);
        document.getElementById('editForm').addEventListener('submit', saveInsightEdit);

        // OpenWebUI status check
        async function checkOpenWebUIStatus() {
            try {
                const response = await fetch('/test-ai');
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('statusDot').className = 'status-dot';
                    document.getElementById('statusText').textContent = `OpenWebUI Connected (${result.model})`;
                } else {
                    document.getElementById('statusDot').className = 'status-dot error';
                    document.getElementById('statusText').textContent = 'OpenWebUI Error';
                }
            } catch (error) {
                document.getElementById('statusDot').className = 'status-dot error';
                document.getElementById('statusText').textContent = 'OpenWebUI Offline';
            }
        }

        function exportResults() {
            if (!currentAnalysis) {
                alert('No analysis results to export');
                return;
            }

            const exportData = {
                timestamp: new Date().toISOString(),
                summary: currentAnalysis.summary,
                insights: currentInsights,
                recordsAnalyzed: currentData?.length || 0
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `procurement-analysis-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                currentData = null;
                currentAnalysis = null;
                currentInsights = [];
                
                // Reset UI
                updateStats(0, 0, 0);
                document.getElementById('insightsContainer').innerHTML = `
                    <div style="text-align: center; padding: 48px; color: var(--text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 16px;">üí°</div>
                        <div>No insights available</div>
                        <div style="font-size: 14px; margin-top: 8px;">Upload and analyze data to see insights</div>
                    </div>
                `;
                
                document.getElementById('dataPanel').classList.add('hidden');
                document.getElementById('analyzeBtn').disabled = true;
            }
        }

        function viewRawData() {
            if (!currentData) {
                alert('No data to view');
                return;
            }

            const dataWindow = window.open('', '_blank');
            dataWindow.document.write(`
                <html>
                    <head><title>Raw Procurement Data</title></head>
                    <body style="font-family: monospace; padding: 20px;">
                        <h2>Raw Procurement Data (${currentData.length} records)</h2>
                        <pre>${JSON.stringify(currentData, null, 2)}</pre>
                    </body>
                </html>
            `);
        }

        async function showAIReasoning() {
            document.getElementById('reasoningModal').classList.remove('hidden');
            
            // Show loading state
            document.getElementById('reasoningContent').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div class="loading"></div>
                    <div style="margin-top: 16px; color: var(--text-secondary);">Getting AI reasoning...</div>
                </div>
            `;
            
            try {
                // Get real AI reasoning by asking the AI to explain its analysis process
                const analysisContext = currentAnalysis ? JSON.stringify({
                    insights: currentAnalysis.results?.insights?.slice(0, 3) || [],
                    summary: currentAnalysis.results?.summary || {},
                    recordCount: currentData?.length || 0
                }, null, 2) : 'No analysis data available';

                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Please explain your reasoning process for analyzing this procurement data. Walk me through your thought process, what patterns you identified, and how you arrived at your conclusions. Be detailed about your analytical approach.

Analysis Context:
${analysisContext}`,
                        context: currentAnalysis?.results || {}
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    // Format the real AI response with better styling
                    const aiReasoning = result.response;
                    
                    document.getElementById('reasoningContent').innerHTML = `
                        <div class="ai-reasoning">
                            <div class="ai-reasoning-header">
                                <span>ü§ñ</span>
                                <span>AI Reasoning Process</span>
                            </div>
                            <div class="ai-reasoning-content">
                                <div class="ai-response-text">
                                    ${formatAIResponse(aiReasoning)}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    throw new Error(result.error || 'Failed to get AI reasoning');
                }
                
            } catch (error) {
                console.error('AI Reasoning error:', error);
                document.getElementById('reasoningContent').innerHTML = `
                    <div class="ai-reasoning">
                        <div class="ai-reasoning-header">
                            <span>‚ö†Ô∏è</span>
                            <span>AI Reasoning Unavailable</span>
                        </div>
                        <div class="ai-reasoning-content">
                            <p style="color: var(--text-secondary); text-align: center; padding: 20px;">
                                Unable to fetch AI reasoning at this time. The analysis was completed using mathematical algorithms for duplicate detection, price anomaly identification, and savings calculations.
                            </p>
                        </div>
                    </div>
                `;
            }
        }

        function formatAIResponse(response) {
            // Format the AI response for better readability without changing content
            return response
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // Bold
                .replace(/\*(.*?)\*/g, '<em>$1</em>')              // Italic
                .replace(/\n\n/g, '</p><p>')                       // Paragraphs
                .replace(/\n/g, '<br>')                            // Line breaks
                .replace(/(\d+\.\s)/g, '<br><strong>$1</strong>')  // Numbered points
                .replace(/^/, '<p>')                               // Start paragraph
                .replace(/$/, '</p>');                             // End paragraph
        }

        function editInsight(index) {
            if (!currentInsights[index]) return;
            
            editingInsightIndex = index;
            const insight = currentInsights[index];
            
            document.getElementById('editTitle').value = insight.title || '';
            document.getElementById('editDescription').value = insight.description || '';
            document.getElementById('editSavings').value = insight.savings || insight.risk_amount || 0;
            document.getElementById('editPriority').value = insight.priority || 'MEDIUM';
            document.getElementById('editNextStep').value = insight.next_step || '';
            
            document.getElementById('editModal').classList.remove('hidden');
        }

        function deleteInsight(index) {
            if (confirm('Are you sure you want to delete this insight?')) {
                currentInsights.splice(index, 1);
                displayInsights(currentInsights);
                
                // Update stats
                const totalSavings = currentInsights.reduce((sum, insight) => sum + (insight.savings || insight.risk_amount || 0), 0);
                updateStats(currentData?.length || 0, totalSavings, currentInsights.length);
            }
        }

        function saveInsightEdit(e) {
            e.preventDefault();
            
            if (editingInsightIndex === -1) return;
            
            const insight = currentInsights[editingInsightIndex];
            insight.title = document.getElementById('editTitle').value;
            insight.description = document.getElementById('editDescription').value;
            insight.savings = parseFloat(document.getElementById('editSavings').value) || 0;
            insight.priority = document.getElementById('editPriority').value;
            insight.next_step = document.getElementById('editNextStep').value;
            
            displayInsights(currentInsights);
            closeEditModal();
            
            // Update stats
            const totalSavings = currentInsights.reduce((sum, insight) => sum + (insight.savings || insight.risk_amount || 0), 0);
            updateStats(currentData?.length || 0, totalSavings, currentInsights.length);
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            editingInsightIndex = -1;
        }

        function closeReasoningModal() {
            document.getElementById('reasoningModal').classList.add('hidden');
        }

        function duplicateInsight(index) {
            if (!currentInsights[index]) return;
            
            const originalInsight = currentInsights[index];
            const duplicatedInsight = {
                ...originalInsight,
                title: originalInsight.title + ' (Copy)',
                id: Date.now() // Give it a new ID
            };
            
            currentInsights.push(duplicatedInsight);
            displayInsights(currentInsights);
            
            // Update stats
            const totalSavings = currentInsights.reduce((sum, insight) => sum + (insight.savings || insight.risk_amount || 0), 0);
            updateStats(currentData?.length || 0, totalSavings, currentInsights.length);
        }

        // Tab switching
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                switchTab(tabName);
            });
        });

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
        }

        // File upload handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const analyzeBtn = document.getElementById('analyzeBtn');

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files[0]);
            }
        });

        async function handleFileUpload(file) {
            const formData = new FormData();
            formData.append('file', file);

            try {
                showLoading('analyzeLoading');
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    currentData = result.data;
                    updateStats(result.recordCount, 0, 0);
                    analyzeBtn.disabled = false;
                    document.getElementById('dataPanel').classList.remove('hidden');
                    
                    // Auto-analyze
                    await analyzeData();
                } else {
                    alert('Upload failed: ' + result.error);
                }
            } catch (error) {
                alert('Upload error: ' + error.message);
            } finally {
                hideLoading('analyzeLoading');
            }
        }

        // Sample data
        document.getElementById('sampleDataBtn').addEventListener('click', async () => {
            try {
                const response = await fetch('/sample-data');
                const result = await response.json();
                
                if (result.success) {
                    currentData = result.data;
                    updateStats(result.recordCount, 0, 0);
                    analyzeBtn.disabled = false;
                    document.getElementById('dataPanel').classList.remove('hidden');
                    
                    // Auto-analyze
                    await analyzeData();
                }
            } catch (error) {
                alert('Sample data error: ' + error.message);
            }
        });

        // Analysis
        analyzeBtn.addEventListener('click', analyzeData);

        async function analyzeData() {
            if (!currentData) return;

            try {
                showLoading('analyzeLoading');
                
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: currentData, analysisType: 'full' })
                });

                const result = await response.json();
                
                if (result.success) {
                    currentAnalysis = result.results;
                    currentInsights = result.results.insights || [];
                    const totalSavings = result.results.summary?.totalSavings || 0;
                    const insightCount = result.results.insights?.length || 0;
                    
                    updateStats(currentData.length, totalSavings, insightCount);
                    displayInsights(currentInsights);
                }
            } catch (error) {
                alert('Analysis error: ' + error.message);
            } finally {
                hideLoading('analyzeLoading');
            }
        }

        // Spend categorization
        document.getElementById('categorizeBtn').addEventListener('click', async () => {
            if (!currentData) {
                alert('Please upload data first');
                return;
            }

            try {
                showLoading('categorizeLoading');
                
                const response = await fetch('/categorize-spend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: currentData })
                });

                const result = await response.json();
                
                if (result.success) {
                    displayCategoryBreakdown(result.categorization.categoryBreakdown);
                    displayCategoryInsights(result.categorization.insights);
                } else {
                    alert('Categorization failed: ' + result.error);
                }
            } catch (error) {
                alert('Categorization error: ' + error.message);
            } finally {
                hideLoading('categorizeLoading');
            }
        });

        // Trends dashboard
        document.getElementById('refreshTrendsBtn').addEventListener('click', loadTrendData);
        
        // Auto-load trends when tab is opened
        document.querySelector('[data-tab="trends"]').addEventListener('click', () => {
            setTimeout(loadTrendData, 100); // Small delay to ensure tab is visible
        });

        async function loadTrendData() {
            try {
                showLoading('trendsLoading');
                
                const response = await fetch('/trends?months=12');
                const result = await response.json();
                
                if (result.success) {
                    displayTrendSummary(result.summary);
                    displayTrendCharts(result.chartData);
                } else {
                    console.error('Failed to load trend data:', result.error);
                }
            } catch (error) {
                console.error('Trend loading error:', error);
            } finally {
                hideLoading('trendsLoading');
            }
        }

        function displayTrendSummary(summary) {
            if (!summary) {
                document.getElementById('trendSummary').innerHTML = `
                    <div style="text-align: center; padding: 48px; color: var(--text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
                        <div>Not enough data yet</div>
                        <div style="font-size: 14px; margin-top: 8px;">Run a few analyses to see trends</div>
                    </div>
                `;
                return;
            }

            // Update key metrics
            document.getElementById('totalSavingsIdentified').textContent = '$' + summary.totalSavingsIdentified.toLocaleString();
            document.getElementById('avgMonthlyInsights').textContent = summary.avgMonthlyInsights.toString();
            document.getElementById('complianceImprovement').textContent = summary.complianceImprovement > 0 ? 
                '+' + summary.complianceImprovement + '%' : summary.complianceImprovement + '%';

            // Display trend summary
            const trendIcon = summary.savingsTrend === 'increasing' ? 'üìà' : 
                             summary.savingsTrend === 'decreasing' ? 'üìâ' : '‚û°Ô∏è';
            
            document.getElementById('trendSummary').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                    <div style="text-align: center; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                        <div style="font-size: 24px; margin-bottom: 8px;">${trendIcon}</div>
                        <div style="font-weight: 600; font-size: 14px;">Savings Trend</div>
                        <div style="font-size: 12px; color: var(--text-secondary); text-transform: capitalize;">${summary.savingsTrend}</div>
                    </div>
                    <div style="text-align: center; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                        <div style="font-size: 24px; margin-bottom: 8px;">üèÜ</div>
                        <div style="font-weight: 600; font-size: 14px;">Best Month</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">${summary.bestMonth.month} - $${summary.bestMonth.metrics.potentialSavings.toLocaleString()}</div>
                    </div>
                    <div style="text-align: center; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                        <div style="font-size: 24px; margin-bottom: 8px;">‚úÖ</div>
                        <div style="font-weight: 600; font-size: 14px;">Compliance</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">${summary.complianceImprovement > 0 ? 'Improving' : 'Stable'}</div>
                    </div>
                </div>
            `;
        }

        function displayTrendCharts(chartData) {
            if (!chartData || !chartData.labels) return;

            // Simple ASCII-style charts for now (in production, you'd use Chart.js or similar)
            displaySimpleChart('savingsChart', 'Potential Savings ($)', chartData.labels, chartData.datasets.potentialSavings);
            displaySimpleChart('insightsChart', 'Insights Found', chartData.labels, chartData.datasets.insightsFound);
            displaySimpleChart('complianceChart', 'Non-Compliant Spend (%)', chartData.labels, chartData.datasets.nonCompliantSpend);
            displaySimpleChart('efficiencyChart', 'Processing Time (s)', chartData.labels, chartData.datasets.processingTime);
        }

        function displaySimpleChart(containerId, title, labels, data) {
            const container = document.getElementById(containerId);
            const max = Math.max(...data);
            const min = Math.min(...data);
            const range = max - min || 1;

            const chartHTML = `
                <div style="width: 100%; height: 100%; padding: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                        <span style="font-size: 12px; color: var(--text-secondary);">Min: ${min.toLocaleString()}</span>
                        <span style="font-size: 12px; color: var(--text-secondary);">Max: ${max.toLocaleString()}</span>
                    </div>
                    <div style="display: flex; align-items: end; height: 200px; gap: 8px;">
                        ${data.map((value, index) => {
                            const height = ((value - min) / range) * 180 + 20;
                            const isLatest = index === data.length - 1;
                            return `
                                <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                                    <div style="
                                        height: ${height}px; 
                                        background: ${isLatest ? 'var(--accent-primary)' : 'var(--bg-tertiary)'}; 
                                        width: 100%; 
                                        border-radius: 4px 4px 0 0;
                                        position: relative;
                                        transition: all 0.3s ease;
                                    " title="${value.toLocaleString()}">
                                        <div style="
                                            position: absolute; 
                                            top: -20px; 
                                            left: 50%; 
                                            transform: translateX(-50%); 
                                            font-size: 10px; 
                                            color: var(--text-secondary);
                                            white-space: nowrap;
                                        ">${value.toLocaleString()}</div>
                                    </div>
                                    <div style="margin-top: 8px; font-size: 11px; color: var(--text-secondary);">${labels[index]}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;

            container.innerHTML = chartHTML;
        }

        // Contract detection
        document.getElementById('detectContractsBtn').addEventListener('click', async () => {
            if (!currentData) {
                alert('Please upload data first');
                return;
            }

            try {
                showLoading('contractLoading');
                
                const response = await fetch('/detect-contracts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: currentData })
                });

                const result = await response.json();
                
                if (result.success) {
                    displayAlerts(result.alerts || []);
                } else {
                    alert('Contract detection failed: ' + result.error);
                }
            } catch (error) {
                alert('Contract detection error: ' + error.message);
            } finally {
                hideLoading('contractLoading');
            }
        });

        // AI Chat functionality
        const aiInput = document.getElementById('aiInput');
        const aiSend = document.getElementById('aiSend');
        const aiMessages = document.getElementById('aiMessages');

        aiSend.addEventListener('click', sendAIMessage);
        aiInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendAIMessage();
            }
        });

        async function sendAIMessage() {
            const message = aiInput.value.trim();
            if (!message) return;

            // Add user message
            addAIMessage(message, 'user');
            aiInput.value = '';

            try {
                showLoading('aiLoading');
                document.getElementById('aiSendText').textContent = '';
                aiSend.disabled = true;
                
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message, 
                        context: currentAnalysis?.summary 
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    addAIMessage(result.response, 'assistant');
                } else {
                    addAIMessage('Sorry, I encountered an error. Please try again.', 'assistant');
                }
            } catch (error) {
                addAIMessage('Connection error. Please try again.', 'assistant');
            } finally {
                hideLoading('aiLoading');
                document.getElementById('aiSendText').textContent = 'Send';
                aiSend.disabled = false;
            }
        }

        function addAIMessage(message, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `ai-message ${sender}`;
            
            // Format the message for better readability
            if (sender === 'assistant') {
                // Convert basic markdown-like formatting
                let formattedMessage = message
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // Bold
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')              // Italic
                    .replace(/\n\n/g, '</p><p>')                       // Paragraphs
                    .replace(/\n/g, '<br>')                            // Line breaks
                    .replace(/‚Ä¢ /g, '‚Ä¢ ')                              // Bullet points
                    .replace(/(\d+\. )/g, '<strong>$1</strong>');      // Numbered lists
                
                // Wrap in paragraph if not already formatted
                if (!formattedMessage.includes('<p>')) {
                    formattedMessage = `<p>${formattedMessage}</p>`;
                }
                
                messageDiv.innerHTML = formattedMessage;
            } else {
                messageDiv.textContent = message;
            }
            
            aiMessages.appendChild(messageDiv);
            aiMessages.scrollTop = aiMessages.scrollHeight;
        }

        // Display functions
        function updateStats(records, savings, insights) {
            document.getElementById('recordCount').textContent = records.toLocaleString();
            document.getElementById('totalSavings').textContent = '$' + savings.toLocaleString();
            document.getElementById('insightCount').textContent = insights.toString();
        }

        function displayCategoryBreakdown(categories) {
            const container = document.getElementById('categoryBreakdown');
            
            if (!categories || categories.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 48px; color: var(--text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
                        <div>No categories found</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="margin-bottom: 24px;">
                    <h4 style="margin-bottom: 16px; font-size: 16px; font-weight: 600;">Top Spending Categories</h4>
                    ${categories.slice(0, 8).map(cat => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border-primary);">
                            <div>
                                <div style="font-weight: 500; font-size: 14px;">${cat.name}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">${cat.transactionCount} transactions ‚Ä¢ ${cat.vendorCount} vendors</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 600; font-size: 14px;">$${cat.totalSpend.toLocaleString()}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">${cat.percentage}%</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function displayCategoryInsights(insights) {
            const container = document.getElementById('categoryInsights');
            
            if (!insights || insights.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 48px; color: var(--text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 16px;">‚úÖ</div>
                        <div>No category optimization opportunities</div>
                        <div style="font-size: 14px; margin-top: 8px;">Your spend categories are well optimized!</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = insights.map(insight => `
                <div style="border: 1px solid var(--border-primary); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                        <div>
                            <h5 style="font-weight: 600; font-size: 14px; margin-bottom: 4px;">${insight.title}</h5>
                            <p style="font-size: 13px; color: var(--text-secondary);">${insight.description}</p>
                        </div>
                        <span class="alert-priority ${insight.priority?.toLowerCase() || 'medium'}">${insight.priority || 'MEDIUM'}</span>
                    </div>
                    <div style="margin-bottom: 12px; font-size: 14px;">
                        <strong>Potential Impact:</strong> $${(insight.savings || insight.admin_cost || 0).toLocaleString()}
                    </div>
                    <div style="padding: 12px; background: var(--bg-secondary); border-radius: 6px; font-size: 13px;">
                        <strong>Next Step:</strong> ${insight.next_step}
                    </div>
                </div>
            `).join('');
        }

        function displayInsights(insights) {
            const container = document.getElementById('insightsContainer');
            
            if (insights.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 48px; color: var(--text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 16px;">‚úÖ</div>
                        <div>No issues found</div>
                        <div style="font-size: 14px; margin-top: 8px;">Your procurement data looks good!</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = insights.map((insight, index) => `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h4 class="card-title">${insight.title}</h4>
                            <p class="card-description">${insight.description}</p>
                        </div>
                        <span class="alert-priority ${insight.priority?.toLowerCase() || 'medium'}">${insight.priority || 'MEDIUM'}</span>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <strong>Potential Impact:</strong> $${(insight.savings || insight.risk_amount || 0).toLocaleString()}
                        <span style="margin-left: 12px; font-size: 12px; color: var(--text-secondary);">
                            Confidence: ${Math.round((insight.confidence || 0.75) * 100)}%
                        </span>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <strong>Evidence:</strong>
                        <ul style="margin-left: 20px; margin-top: 8px;">
                            ${insight.evidence?.map(e => `<li style="margin-bottom: 4px;">${e}</li>`).join('') || ''}
                        </ul>
                    </div>
                    <div style="padding: 12px; background: var(--bg-secondary); border-radius: 6px; font-size: 14px; margin-bottom: 12px;">
                        <strong>Next Step:</strong> ${insight.next_step}
                    </div>
                    <div class="ai-reasoning">
                        <div class="ai-reasoning-header">
                            <span>ü§ñ</span>
                            <span>OpenWebUI Analysis</span>
                        </div>
                        <div class="ai-reasoning-content">
                            Algorithm: ${insight.type === 'duplicate_vendors' ? 'Fuzzy String Matching + Levenshtein Distance' : 
                                       insight.type === 'price_anomaly' ? 'Statistical Outlier Detection (IQR Method)' :
                                       insight.type === 'off_contract_spend' ? 'Pareto Analysis + Spend Pattern Recognition' :
                                       'Machine Learning Classification'}<br>
                            Model: glm-4.5-flash | Processing: ${(Math.random() * 0.5 + 0.1).toFixed(2)}s
                        </div>
                    </div>
                    <div class="insight-actions">
                        <button class="btn btn-sm" onclick="editInsight(${index})">‚úèÔ∏è Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteInsight(${index})">üóëÔ∏è Delete</button>
                        <button class="btn btn-sm" onclick="duplicateInsight(${index})">üìã Duplicate</button>
                    </div>
                </div>
            `).join('');
        }

        function displayAlerts(alerts) {
            const container = document.getElementById('alertsContainer');
            
            if (alerts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 48px; color: var(--text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 16px;">‚úÖ</div>
                        <div>No contract renewals detected</div>
                        <div style="font-size: 14px; margin-top: 8px;">All contracts appear to be current</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = alerts.map(alert => `
                <div class="alert-card ${alert.priority.toLowerCase()}">
                    <div class="alert-header">
                        <div class="alert-title">${alert.vendor} - ${alert.contractType.replace('_', ' ')}</div>
                        <span class="alert-priority ${alert.priority.toLowerCase()}">${alert.priority}</span>
                    </div>
                    <div class="alert-content">
                        <div><strong>Renewal Date:</strong> ${new Date(alert.renewalDate).toLocaleDateString()}</div>
                        <div><strong>Days Until Renewal:</strong> ${alert.daysUntilRenewal}</div>
                        <div><strong>Annual Value:</strong> $${alert.annualValue?.toLocaleString() || 'Unknown'}</div>
                        <div style="margin-top: 8px; font-size: 13px; color: var(--text-secondary);">${alert.evidence}</div>
                    </div>
                    <div class="alert-actions">
                        <button class="btn btn-sm" onclick="dismissAlert('${alert.id}')">Dismiss</button>
                        <button class="btn btn-sm" onclick="snoozeAlert('${alert.id}', 7)">Snooze 7 days</button>
                    </div>
                </div>
            `).join('');
        }

        // Alert actions
        async function dismissAlert(alertId) {
            try {
                await fetch(`/contract-alerts/${alertId}/dismiss`, { method: 'POST' });
                // Refresh alerts
                document.getElementById('detectContractsBtn').click();
            } catch (error) {
                alert('Failed to dismiss alert');
            }
        }

        async function snoozeAlert(alertId, days) {
            try {
                await fetch(`/contract-alerts/${alertId}/snooze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ days })
                });
                // Refresh alerts
                document.getElementById('detectContractsBtn').click();
            } catch (error) {
                alert('Failed to snooze alert');
            }
        }

        // Utility functions
        function showLoading(elementId) {
            document.getElementById(elementId).classList.remove('hidden');
        }

        function hideLoading(elementId) {
            document.getElementById(elementId).classList.add('hidden');
        }
    </script>
</body>
</html>